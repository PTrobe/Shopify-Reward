{% comment %}
  Customer Loyalty Status Block
  Displays current customer loyalty status, points balance, tier, and progress
{% endcomment %}

{% if customer %}
  <div class="loyco-customer-status"
       data-customer-id="{{ customer.id }}"
       data-shop="{{ shop.permanent_domain }}"
       style="--loyco-primary-color: {{ block.settings.primary_color }};">

    {% if block.settings.heading != blank %}
      <h3 class="loyco-status-heading">{{ block.settings.heading }}</h3>
    {% endif %}

    <div class="loyco-status-loading">
      <div class="loyco-spinner"></div>
      <p>Loading your loyalty status...</p>
    </div>

    <div class="loyco-status-content" style="display: none;">
      {% if block.settings.show_points %}
        <div class="loyco-points-balance">
          <div class="loyco-points-icon">üéÅ</div>
          <div class="loyco-points-info">
            <span class="loyco-points-value" data-points>0</span>
            <span class="loyco-points-label" data-points-name>points</span>
          </div>
        </div>
      {% endif %}

      {% if block.settings.show_tier %}
        <div class="loyco-current-tier" data-tier style="display: none;">
          <div class="loyco-tier-badge">
            <span class="loyco-tier-icon" data-tier-icon></span>
            <span class="loyco-tier-name" data-tier-name></span>
          </div>
        </div>
      {% endif %}

      {% if block.settings.show_progress %}
        <div class="loyco-tier-progress" data-progress style="display: none;">
          <div class="loyco-progress-info">
            <span class="loyco-progress-text">
              <span data-points-to-next>0</span> points to next tier
            </span>
          </div>
          <div class="loyco-progress-bar">
            <div class="loyco-progress-fill" data-progress-fill style="width: 0%;"></div>
          </div>
        </div>
      {% endif %}

      <div class="loyco-enrollment-prompt" data-enrollment style="display: none;">
        <p>Join our loyalty program to start earning points!</p>
        <button class="loyco-enroll-btn" data-enroll-btn>Join Now</button>
      </div>
    </div>

    <div class="loyco-status-error" style="display: none;">
      <p>Unable to load loyalty status. Please try again later.</p>
    </div>
  </div>

  <script>
    // Initialize customer status block
    document.addEventListener('DOMContentLoaded', function() {
      const statusBlock = document.querySelector('.loyco-customer-status');
      if (!statusBlock) return;

      const customerId = statusBlock.dataset.customerId;
      const shop = statusBlock.dataset.shop;

      if (!customerId || !shop) {
        showEnrollmentPrompt(statusBlock);
        return;
      }

      loadCustomerStatus(statusBlock, customerId, shop);
    });

    function loadCustomerStatus(block, customerId, shop) {
      const loadingEl = block.querySelector('.loyco-status-loading');
      const contentEl = block.querySelector('.loyco-status-content');
      const errorEl = block.querySelector('.loyco-status-error');

      // Show loading state
      loadingEl.style.display = 'block';
      contentEl.style.display = 'none';
      errorEl.style.display = 'none';

      // Build App Proxy URL
      const proxyUrl = `/apps/loyco-rewards/api/customer/${customerId}/status?shop=${shop}&timestamp=${Date.now()}&signature=temp`;

      fetch(proxyUrl)
        .then(response => response.json())
        .then(data => {
          loadingEl.style.display = 'none';

          if (data.enrolled) {
            populateCustomerStatus(block, data);
            contentEl.style.display = 'block';
          } else {
            showEnrollmentPrompt(block);
          }
        })
        .catch(error => {
          console.error('Failed to load loyalty status:', error);
          loadingEl.style.display = 'none';
          errorEl.style.display = 'block';
        });
    }

    function populateCustomerStatus(block, data) {
      // Update points balance
      const pointsValue = block.querySelector('[data-points]');
      const pointsName = block.querySelector('[data-points-name]');
      if (pointsValue) pointsValue.textContent = data.customer.pointsBalance.toLocaleString();
      if (pointsName) pointsName.textContent = data.program.pointsName || 'points';

      // Update tier information
      if (data.tier) {
        const tierEl = block.querySelector('[data-tier]');
        const tierName = block.querySelector('[data-tier-name]');
        const tierIcon = block.querySelector('[data-tier-icon]');

        if (tierEl) {
          tierEl.style.display = 'block';
          tierEl.style.setProperty('--tier-color', data.tier.color);
        }
        if (tierName) tierName.textContent = data.tier.name;
        if (tierIcon) tierIcon.textContent = data.tier.icon || '‚≠ê';
      }

      // Update progress to next tier
      if (data.nextTier) {
        const progressEl = block.querySelector('[data-progress]');
        const pointsToNext = block.querySelector('[data-points-to-next]');
        const progressFill = block.querySelector('[data-progress-fill]');

        if (progressEl) progressEl.style.display = 'block';
        if (pointsToNext) pointsToNext.textContent = data.nextTier.pointsNeeded.toLocaleString();

        if (progressFill) {
          const progressPercent = ((data.customer.lifetimePoints / data.nextTier.requiredPoints) * 100);
          progressFill.style.width = Math.min(progressPercent, 100) + '%';
        }
      }
    }

    function showEnrollmentPrompt(block) {
      const loadingEl = block.querySelector('.loyco-status-loading');
      const enrollmentEl = block.querySelector('[data-enrollment]');
      const enrollBtn = block.querySelector('[data-enroll-btn]');

      loadingEl.style.display = 'none';
      enrollmentEl.style.display = 'block';

      if (enrollBtn) {
        enrollBtn.addEventListener('click', function() {
          // Redirect to account/register or show enrollment modal
          window.location.href = '/account/register';
        });
      }
    }
  </script>

  <style>
    .loyco-customer-status {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      margin: 16px 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .loyco-status-heading {
      margin: 0 0 16px 0;
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
    }

    .loyco-status-loading {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 20px 0;
    }

    .loyco-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid var(--loyco-primary-color, #6366f1);
      border-radius: 50%;
      animation: loyco-spin 1s linear infinite;
    }

    @keyframes loyco-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loyco-points-balance {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .loyco-points-icon {
      font-size: 2rem;
    }

    .loyco-points-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--loyco-primary-color, #6366f1);
    }

    .loyco-points-label {
      font-size: 0.875rem;
      color: #6b7280;
      margin-left: 4px;
    }

    .loyco-current-tier {
      margin-bottom: 16px;
    }

    .loyco-tier-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--tier-color, #f3f4f6);
      color: #1f2937;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .loyco-tier-progress {
      margin-bottom: 16px;
    }

    .loyco-progress-info {
      margin-bottom: 8px;
      font-size: 0.875rem;
      color: #6b7280;
    }

    .loyco-progress-bar {
      height: 8px;
      background: #f3f4f6;
      border-radius: 4px;
      overflow: hidden;
    }

    .loyco-progress-fill {
      height: 100%;
      background: var(--loyco-primary-color, #6366f1);
      transition: width 0.3s ease;
    }

    .loyco-enrollment-prompt {
      text-align: center;
      padding: 20px 0;
    }

    .loyco-enrollment-prompt p {
      margin-bottom: 16px;
      color: #6b7280;
    }

    .loyco-enroll-btn {
      background: var(--loyco-primary-color, #6366f1);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .loyco-enroll-btn:hover {
      background: color-mix(in srgb, var(--loyco-primary-color, #6366f1) 90%, black);
    }

    .loyco-status-error {
      text-align: center;
      padding: 20px 0;
      color: #dc2626;
    }
  </style>
{% endif %}