{% comment %}
  Product points earning display block
  Shows how many points customers will earn for purchasing this product
{% endcomment %}

{% assign product_price = product.price | default: 2500 %}
{% assign points_per_dollar = block.settings.points_per_dollar | default: 1 %}
{% assign points_earned = product_price | divided_by: 100 | times: points_per_dollar %}

{% comment %} Only show if there's a product and points are earned {% endcomment %}
{% if product and points_earned > 0 %}
<div class="loyco-product-points" style="
  background: {{ block.settings.background_color }};
  border: 1px solid {{ block.settings.border_color }};
  border-radius: {{ block.settings.border_radius }}px;
  padding: {{ block.settings.padding }}px;
  margin: {{ block.settings.margin }}px 0;
  display: {{ block.settings.display_style }};
  align-items: center;
  gap: 8px;
  {% if block.settings.display_style == 'flex' %}justify-content: {{ block.settings.alignment }};{% else %}text-align: {{ block.settings.alignment }};{% endif %}
">

  {% if block.settings.show_icon %}
  <span class="loyco-points-icon" style="
    font-size: {{ block.settings.icon_size }}px;
    color: {{ block.settings.icon_color }};
    line-height: 1;
  ">
    {% case block.settings.icon_type %}
      {% when 'star' %}‚òÖ
      {% when 'coin' %}ü™ô
      {% when 'diamond' %}üíé
      {% when 'crown' %}üëë
      {% else %}‚≠ê
    {% endcase %}
  </span>
  {% endif %}

  <div class="loyco-points-text">
    {% if block.settings.custom_message != blank %}
      <span style="
        color: {{ block.settings.text_color }};
        font-size: {{ block.settings.text_size }}px;
        font-weight: {{ block.settings.font_weight }};
        line-height: 1.4;
      ">
        {{ block.settings.custom_message | replace: 'POINTS_PLACEHOLDER', points_earned | replace: 'CURRENCY_PLACEHOLDER', block.settings.points_currency }}
      </span>
    {% else %}
      {% if customer %}
        <div id="loyco-customer-info-{{ block.id }}" data-customer-id="{{ customer.id }}" style="
          color: {{ block.settings.text_color }};
          font-size: {{ block.settings.text_size }}px;
          font-weight: {{ block.settings.font_weight }};
          line-height: 1.4;
        ">
          <span class="loyco-main-text">Earn {{ points_earned }} {{ block.settings.points_currency }} with this purchase</span>
          <div class="loyco-enrollment-area" style="display: none; margin-top: 8px;">
            <button class="loyco-enroll-btn" style="
              background: {{ block.settings.enroll_button_bg | default: '#F59E0B' }};
              color: {{ block.settings.enroll_button_text | default: '#FFFFFF' }};
              border: none;
              padding: 8px 16px;
              border-radius: 4px;
              cursor: pointer;
              font-size: inherit;
              transition: opacity 0.2s ease;
            " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
              {{ block.settings.enroll_button_label | default: 'Join Now' }}
            </button>
          </div>
        </div>
      {% else %}
        <div style="
          color: {{ block.settings.text_color }};
          font-size: {{ block.settings.text_size }}px;
          font-weight: {{ block.settings.font_weight }};
          line-height: 1.4;
        ">
          <span>Sign up and earn {{ points_earned }} {{ block.settings.points_currency }}</span>
          {% if block.settings.show_guest_signup %}
          <div style="margin-top: 8px;">
            <a href="{{ routes.account_url }}" style="
              background: {{ block.settings.signup_button_bg }};
              color: {{ block.settings.signup_button_text }};
              padding: 6px 12px;
              border-radius: 4px;
              text-decoration: none;
              font-size: {{ block.settings.text_size | times: 0.9 }}px;
              display: inline-block;
              transition: opacity 0.2s ease;
            " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
              {{ block.settings.signup_button_text_label }}
            </a>
          </div>
          {% endif %}
        </div>
      {% endif %}
    {% endif %}

    {% if block.settings.show_bonus_message and block.settings.bonus_message != blank %}
    <div class="loyco-bonus-message" style="
      color: {{ block.settings.bonus_color }};
      font-size: {{ block.settings.text_size | times: 0.85 }}px;
      margin-top: 4px;
      font-style: italic;
    ">
      {{ block.settings.bonus_message }}
    </div>
    {% endif %}
  </div>

  {% if block.settings.show_total_needed and block.settings.reward_threshold > 0 %}
  <div class="loyco-progress-hint" style="
    color: {{ block.settings.hint_color }};
    font-size: {{ block.settings.text_size | times: 0.8 }}px;
    margin-left: auto;
    white-space: nowrap;
  ">
    {% assign remaining = block.settings.reward_threshold | minus: points_earned %}
    {% if remaining > 0 %}
      {{ remaining }} more for reward
    {% else %}
      üéâ Reward unlocked!
    {% endif %}
  </div>
  {% endif %}
</div>

<style>
.loyco-product-points {
  transition: all 0.3s ease;
}

{% if block.settings.enable_hover_effect %}
.loyco-product-points:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border-color: {{ block.settings.hover_border_color }};
}
{% endif %}

@media (max-width: 768px) {
  .loyco-product-points {
    padding: {{ block.settings.padding | times: 0.75 }}px;
    font-size: {{ block.settings.text_size | times: 0.9 }}px;
  }

  .loyco-progress-hint {
    display: {% if block.settings.hide_progress_mobile %}none{% else %}block{% endif %};
    margin-left: 0;
    margin-top: 4px;
  }
}
</style>

{% if customer %}
<script>
(function() {
  try {
    var container = document.getElementById('loyco-customer-info-{{ block.id }}');
    if (!container) return;

    var customerId = container.getAttribute('data-customer-id');
    if (!customerId) return;

    var mainTextEl = container.querySelector('.loyco-main-text');
    var enrollmentArea = container.querySelector('.loyco-enrollment-area');
    var enrollBtn = container.querySelector('.loyco-enroll-btn');

    // Check customer enrollment status
    var shopDomain = '{{ shop.permanent_domain }}';
    var statusUrl = '/apps/loyco-rewards/api/customer/' + customerId + '/status?shop=' + shopDomain + '&timestamp=' + Date.now() + '&signature=dummy';
    fetch(statusUrl, { credentials: 'include' })
      .then(function(response) {
        if (!response.ok) throw new Error('Request failed');
        return response.json();
      })
      .then(function(data) {
        if (data && !data.enrolled) {
          // Customer not enrolled - show enrollment button
          mainTextEl.textContent = 'Join and earn {{ points_earned }} {{ block.settings.points_currency }}!';
          enrollmentArea.style.display = 'block';
        } else if (data && data.enrolled && data.customer) {
          // Customer enrolled - show balance
          mainTextEl.textContent = 'Earn {{ points_earned }} {{ block.settings.points_currency }} with this purchase';
          var balanceEl = document.createElement('div');
          balanceEl.style.cssText = 'margin-top: 4px; font-size: 0.9em; opacity: 0.8;';
          balanceEl.textContent = 'Current balance: ' + (data.customer.pointsBalance || 0) + ' ' + (data.program ? data.program.pointsName : '{{ block.settings.points_currency }}');
          container.appendChild(balanceEl);
        }
      })
      .catch(function() {
        // Keep default text on error
        console.warn('Loyco: Unable to load customer status');
      });

    // Handle enrollment
    if (enrollBtn) {
      enrollBtn.addEventListener('click', function() {
        var btn = this;
        var originalText = btn.textContent;
        btn.textContent = 'Joining...';
        btn.disabled = true;

        var enrollUrl = '/apps/loyco-rewards/api/customer/enroll?shop=' + shopDomain + '&timestamp=' + Date.now() + '&signature=dummy';
        fetch(enrollUrl, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            shopifyCustomerId: customerId,
            email: '{{ customer.email }}',
            firstName: '{{ customer.first_name }}',
            lastName: '{{ customer.last_name }}',
            phone: '{{ customer.phone }}'
          })
        })
        .then(function(response) {
          if (!response.ok) throw new Error('Enrollment failed');
          return response.json();
        })
        .then(function(data) {
          if (data.success) {
            mainTextEl.textContent = 'Enrolled! Earn {{ points_earned }} {{ block.settings.points_currency }}';
            enrollmentArea.style.display = 'none';
            if (data.welcomeBonus) {
              var welcomeEl = document.createElement('div');
              welcomeEl.style.cssText = 'margin-top: 8px; padding: 8px; background: #10B981; color: white; border-radius: 4px; font-size: 0.9em;';
              welcomeEl.textContent = 'üéâ Welcome bonus: ' + data.welcomeBonus.points + ' {{ block.settings.points_currency }}!';
              container.appendChild(welcomeEl);
            }
          } else {
            throw new Error('Enrollment failed');
          }
        })
        .catch(function() {
          btn.textContent = 'Try Again';
          btn.disabled = false;
        });
      });
    }
  } catch (error) {
    console.warn('Loyco: Product points script error', error);
  }
})();
</script>
{% endif %}
{% endif %}

{% schema %}
{
  "name": "Product Points Earning",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Points Configuration"
    },
    {
      "type": "number",
      "id": "points_per_dollar",
      "label": "Points per dollar spent",
      "default": 1
    },
    {
      "type": "text",
      "id": "points_currency",
      "label": "Points Currency Name",
      "default": "points",
      "info": "e.g., points, stars, coins"
    },
    {
      "type": "textarea",
      "id": "custom_message",
      "label": "Custom Message",
      "placeholder": "Earn POINTS_PLACEHOLDER CURRENCY_PLACEHOLDER with this purchase",
      "info": "Use POINTS_PLACEHOLDER for points amount and CURRENCY_PLACEHOLDER for currency name"
    },
    {
      "type": "header",
      "content": "Appearance"
    },
    {
      "type": "select",
      "id": "display_style",
      "label": "Display Style",
      "options": [
        { "value": "block", "label": "Stacked" },
        { "value": "flex", "label": "Inline" }
      ],
      "default": "flex"
    },
    {
      "type": "select",
      "id": "alignment",
      "label": "Alignment",
      "options": [
        { "value": "flex-start", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "flex-end", "label": "Right" }
      ],
      "default": "flex-start"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#F3F4F6"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border Color",
      "default": "#E5E7EB"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#374151"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border Radius",
      "min": 0,
      "max": 20,
      "step": 2,
      "default": 6
    },
    {
      "type": "range",
      "id": "padding",
      "label": "Padding",
      "min": 8,
      "max": 24,
      "step": 2,
      "default": 12
    },
    {
      "type": "range",
      "id": "margin",
      "label": "Vertical Margin",
      "min": 0,
      "max": 30,
      "step": 5,
      "default": 15
    },
    {
      "type": "range",
      "id": "text_size",
      "label": "Text Size",
      "min": 12,
      "max": 18,
      "step": 1,
      "default": 14
    },
    {
      "type": "select",
      "id": "font_weight",
      "label": "Font Weight",
      "options": [
        { "value": "400", "label": "Normal" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semi Bold" },
        { "value": "700", "label": "Bold" }
      ],
      "default": "500"
    },
    {
      "type": "header",
      "content": "Icon"
    },
    {
      "type": "checkbox",
      "id": "show_icon",
      "label": "Show icon",
      "default": true
    },
    {
      "type": "select",
      "id": "icon_type",
      "label": "Icon Type",
      "options": [
        { "value": "star", "label": "Star ‚òÖ" },
        { "value": "coin", "label": "Coin ü™ô" },
        { "value": "diamond", "label": "Diamond üíé" },
        { "value": "crown", "label": "Crown üëë" }
      ],
      "default": "star"
    },
    {
      "type": "color",
      "id": "icon_color",
      "label": "Icon Color",
      "default": "#F59E0B"
    },
    {
      "type": "range",
      "id": "icon_size",
      "label": "Icon Size",
      "min": 12,
      "max": 24,
      "step": 2,
      "default": 16
    },
    {
      "type": "header",
      "content": "Bonus Messages"
    },
    {
      "type": "checkbox",
      "id": "show_bonus_message",
      "label": "Show bonus message",
      "default": false
    },
    {
      "type": "text",
      "id": "bonus_message",
      "label": "Bonus Message",
      "placeholder": "Double points this week!"
    },
    {
      "type": "color",
      "id": "bonus_color",
      "label": "Bonus Message Color",
      "default": "#DC2626"
    },
    {
      "type": "header",
      "content": "Reward Progress"
    },
    {
      "type": "checkbox",
      "id": "show_total_needed",
      "label": "Show progress to reward",
      "default": false
    },
    {
      "type": "number",
      "id": "reward_threshold",
      "label": "Next reward threshold",
      "default": 100
    },
    {
      "type": "color",
      "id": "hint_color",
      "label": "Progress hint color",
      "default": "#6B7280"
    },
    {
      "type": "header",
      "content": "Interactive Effects"
    },
    {
      "type": "checkbox",
      "id": "enable_hover_effect",
      "label": "Enable hover effect",
      "default": true
    },
    {
      "type": "color",
      "id": "hover_border_color",
      "label": "Hover border color",
      "default": "#F59E0B"
    },
    {
      "type": "checkbox",
      "id": "hide_progress_mobile",
      "label": "Hide progress hint on mobile",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_guest_signup",
      "label": "Show signup button for guests",
      "default": true
    },
    {
      "type": "text",
      "id": "signup_button_text_label",
      "label": "Guest signup button text",
      "default": "Sign Up"
    },
    {
      "type": "color",
      "id": "signup_button_bg",
      "label": "Guest signup button background",
      "default": "#2563EB"
    },
    {
      "type": "color",
      "id": "signup_button_text",
      "label": "Guest signup button text color",
      "default": "#FFFFFF"
    },
    {
      "type": "text",
      "id": "enroll_button_label",
      "label": "Enrollment button text",
      "default": "Join Now"
    },
    {
      "type": "color",
      "id": "enroll_button_bg",
      "label": "Enrollment button background",
      "default": "#F59E0B"
    },
    {
      "type": "color",
      "id": "enroll_button_text",
      "label": "Enrollment button text color",
      "default": "#FFFFFF"
    }
  ]
}
{% endschema %}