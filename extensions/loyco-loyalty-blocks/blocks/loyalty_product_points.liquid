{% comment %}
  Product Points Indicator Block
  Shows how many points customers can earn from purchasing this product
{% endcomment %}

{% if product %}
  <div class="loyco-product-points"
       data-product-id="{{ product.id }}"
       data-product-price="{{ product.price }}"
       data-shop="{{ shop.permanent_domain }}"
       data-text-template="{{ block.settings.text_template }}"
       data-show-tier-multiplier="{{ block.settings.show_tier_multiplier }}">

    <div class="loyco-points-loading" style="display: none;">
      <div class="loyco-mini-spinner"></div>
    </div>

    <div class="loyco-points-display" style="display: none;">
      <span class="loyco-points-icon">üéÅ</span>
      <span class="loyco-points-text"></span>
      <span class="loyco-tier-bonus" style="display: none;"></span>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const pointsBlock = document.querySelector('.loyco-product-points');
      if (!pointsBlock) return;

      loadProductPoints(pointsBlock);
    });

    function loadProductPoints(block) {
      const shop = block.dataset.shop;
      const productPrice = parseInt(block.dataset.productPrice);
      const textTemplate = block.dataset.textTemplate;
      const showTierMultiplier = block.dataset.showTierMultiplier === 'true';

      if (!shop || !productPrice) return;

      const loadingEl = block.querySelector('.loyco-points-loading');
      const displayEl = block.querySelector('.loyco-points-display');

      // Show loading
      loadingEl.style.display = 'inline-flex';

      // Get loyalty program info
      const programUrl = `/apps/loyco-rewards/api/program?shop=${shop}&timestamp=${Date.now()}&signature=temp`;

      fetch(programUrl)
        .then(response => response.json())
        .then(data => {
          if (data.active) {
            const basePoints = Math.floor((productPrice / 100) * data.pointsPerDollar);
            updatePointsDisplay(block, basePoints, data, showTierMultiplier, textTemplate);
          }
          loadingEl.style.display = 'none';
        })
        .catch(error => {
          console.error('Failed to load product points:', error);
          loadingEl.style.display = 'none';
        });
    }

    function updatePointsDisplay(block, basePoints, programData, showTierMultiplier, textTemplate) {
      const displayEl = block.querySelector('.loyco-points-display');
      const pointsText = block.querySelector('.loyco-points-text');
      const tierBonus = block.querySelector('.loyco-tier-bonus');

      if (!displayEl || !pointsText) return;

      // Basic points display
      const pointsMessage = textTemplate.replace('{points}', basePoints.toLocaleString());
      pointsText.textContent = pointsMessage;

      // Show tier multiplier if customer is logged in and has a tier
      if (showTierMultiplier && window.loycoCustomerData?.tier?.pointsMultiplier > 1) {
        const multipliedPoints = Math.floor(basePoints * window.loycoCustomerData.tier.pointsMultiplier);
        const bonusPoints = multipliedPoints - basePoints;

        if (bonusPoints > 0) {
          tierBonus.textContent = ` (+${bonusPoints} tier bonus)`;
          tierBonus.style.display = 'inline';
        }
      }

      displayEl.style.display = 'inline-flex';
    }

    // Listen for customer data updates
    document.addEventListener('loycoCustomerLoaded', function(event) {
      const pointsBlock = document.querySelector('.loyco-product-points');
      if (pointsBlock) {
        loadProductPoints(pointsBlock);
      }
    });
  </script>

  <style>
    .loyco-product-points {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin: 8px 0;
      font-size: 0.875rem;
      color: #059669;
      font-weight: 500;
    }

    .loyco-points-loading {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .loyco-mini-spinner {
      width: 12px;
      height: 12px;
      border: 1.5px solid #d1d5db;
      border-top: 1.5px solid #059669;
      border-radius: 50%;
      animation: loyco-spin 1s linear infinite;
    }

    .loyco-points-display {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .loyco-points-icon {
      font-size: 1rem;
    }

    .loyco-tier-bonus {
      color: #7c3aed;
      font-weight: 400;
    }

    @keyframes loyco-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Position variations */
    .loyco-product-points[data-position="above_price"] {
      order: -2;
    }

    .loyco-product-points[data-position="below_price"] {
      order: -1;
    }

    .loyco-product-points[data-position="above_buttons"] {
      order: 1;
    }

    .loyco-product-points[data-position="below_buttons"] {
      order: 2;
    }
  </style>
{% endif %}